package com.java.lib;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

public class LibraryDaoImpl implements LibraryDAO {

    Connection connection;
    PreparedStatement pst;

    public boolean checkPassword(String pwd, String retype) {
        if (pwd.equals(retype)) {
            return true;
        }
        return false;
    }

    @Override
    public String createUser(LibUsers libUsers) throws ClassNotFoundException, SQLException {
        connection = ConnectionHelper.getConnection();
        String encPwd = EncryptPassword.getCode(libUsers.getPassWord());
        String cmd = "Insert into LibUsers(UserName, Password) values (?,?)";
        pst = connection.prepareStatement(cmd);
        pst.setString(1, libUsers.getUserName());
        pst.setString(2, encPwd);
        pst.executeUpdate();
        return "User account Created";
    }

    @Override
    public int authenticate(LibUsers libUsers) throws SQLException, ClassNotFoundException {
        connection = ConnectionHelper.getConnection();
        String encr = EncryptPassword.getCode(libUsers.getPassWord());
        String cmd = "select count(*) cnt from LibUsers where userName=? AND Password=?";
        pst = connection.prepareStatement(cmd);
        pst.setString(1, libUsers.getUserName());
        pst.setString(2, encr.trim());
        ResultSet rs = pst.executeQuery();
        rs.next();
        int count = rs.getInt("cnt");
        return count;
    }

    @Override
    public List<Books> searchBooks(String searchType, String searchValue) throws ClassNotFoundException, SQLException {
        String Sql;
        boolean isValid = true;
        if (searchType.equals("id")) {
            Sql = "select * from books where ID=?";
        } else if (searchType.equals("bookname")) {
            Sql = "select * from books where Name=?";
        } else if (searchType.equals("authorname")) {
            Sql = "select * from books where Author=?";
        } else if (searchType.equals("dept")) {
            Sql = "select * from books where Dept=?";
        } else {
            isValid = false;
            Sql = "select * from books";
        }
        connection = ConnectionHelper.getConnection();
        try {
            pst = connection.prepareStatement(Sql);
            if (isValid) {
                pst.setString(1, searchValue);
            }
            ResultSet rs = pst.executeQuery();
            Books books = null;
            List<Books> booksList = new ArrayList<Books>();
            while (rs.next()) {
                books = new Books();
                books.setId(rs.getInt("id"));
                books.setName(rs.getString("name"));
                books.setAuthor(rs.getString("author"));
                books.setEdition(rs.getString("edition"));
                books.setDept(rs.getString("dept"));
                books.setNoOfBooks(rs.getInt("TotalBooks"));
                booksList.add(books);
            }
            return booksList;
        } catch (SQLException e) {
            e.printStackTrace();
            return new ArrayList<Books>();
        }
    }

    @Override
    public String issueBooks(List<Integer> bookIds, String userName) throws SQLException, ClassNotFoundException {
        Connection connection = null;
        PreparedStatement issueStmt = null;
        PreparedStatement updateBooksStmt = null;
        ResultSet resultSet = null;

        try {
            connection = ConnectionHelper.getConnection();
            connection.setAutoCommit(false); // Enable manual transaction control

            // Check if the user has already issued the selected books
            String checkIssuedBooksSql = "SELECT BookId FROM TranBook WHERE Username = ?";
            issueStmt = connection.prepareStatement(checkIssuedBooksSql);
            issueStmt.setString(1, userName);
            resultSet = issueStmt.executeQuery();
            
            // Create a set to store issued book IDs for the user
            Set<Integer> issuedBookIds = new HashSet();
            while (resultSet.next()) {
                issuedBookIds.add(resultSet.getInt("BookId"));
            }

            // Prepare SQL statements for issuing books and updating book counts
            String issueBookSql = "INSERT INTO TranBook (Username, BookId) VALUES (?, ?)";
            String updateBookCountSql = "UPDATE Books SET TotalBooks = TotalBooks - 1 WHERE Id = ?";
            issueStmt = connection.prepareStatement(issueBookSql);
            updateBooksStmt = connection.prepareStatement(updateBookCountSql);

            // Iterate through the selected book IDs
            for (Integer bookId : bookIds) {
                // Check if the book is available and not already issued to the user
                if (!issuedBookIds.contains(bookId)) {
                    // Issue the book to the user
                    issueStmt.setString(1, userName);
                    issueStmt.setInt(2, bookId);
                    issueStmt.executeUpdate();

                    // Update the book count
                    updateBooksStmt.setInt(1, bookId);
                    updateBooksStmt.executeUpdate();
                }
            }

            // Commit the transaction
            connection.commit();
            return "Books have been issued successfully.";
        } catch (SQLException e) {
            // Handle any SQL exceptions and roll back the transaction
            if (connection != null) {
                connection.rollback();
            }
            e.printStackTrace();
            return "Failed to issue books. Please try again.";
        } finally {
            // Close resources
            if (resultSet != null) {
                resultSet.close();
            }
            if (issueStmt != null) {
                issueStmt.close();
            }
            if (updateBooksStmt != null) {
                updateBooksStmt.close();
            }
            if (connection != null) {
                connection.close();
            }
        }
    }


  
    }

