package com.java.jsp;

import java.security.SecureRandom;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;

public class PatientDaoImpl implements PatientDao {
    SessionFactory sf;
    Session session;

    @Override
    public String addPatient(Patient patient) {
        sf = SessionHelper.getConnection();
        session = sf.openSession();
        Transaction trans = session.beginTransaction();

        // Generate UHID and set it in the Patient entity
        String uhid = generateUHID();
        patient.setUhid(uhid);
        
        // Set the status to "Pending" by default
        patient.setStatus("Pending");

        // Save the Patient entity
        session.save(patient);

        String otp = generateOtp(8); 

        String body = "Welcome to Mr/Miss " + patient.getFirstName() + "\r\n" + "Your OTP Generated Successfully..."
                + "\r\n" + "OTP is " + otp;

        MailSend.mailOtp(patient.getEmail(), "Otp Sent Successfully...", body); 
       
        trans.commit();
        session.close();

        session = sf.openSession();
        Transaction trans2 = session.beginTransaction();

        Login login = new Login();
        login.setUhid(patient.getUhid()); 
        login.setUsername(patient.getUserName());
        login.setOtp(otp);

        session.save(login);

        trans2.commit();
        session.close();

        return "Welcome.jsp?faces-redirect=true";
    }

    public static String generateOtp(int length) {
        String characters = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        SecureRandom secureRandom = new SecureRandom();
        StringBuilder otp = new StringBuilder(length);

        for (int i = 0; i < length; i++) {
            int randomIndex = secureRandom.nextInt(characters.length());
            char randomChar = characters.charAt(randomIndex);
            otp.append(randomChar);
        }

        return otp.toString();
    }

    private static int uhidCounter = 1;

    private static String generateUHID() {
        // Generate UHID in the format "IN0001", "IN0002", and so on
        String uhid = String.format("IN%04d", uhidCounter);
        uhidCounter++;
        return uhid;
    }
}
