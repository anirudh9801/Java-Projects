package com.java.rms;

import java.sql.Date;	
import java.util.Map;
import java.util.List;

import javax.faces.context.FacesContext;

import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;
import org.hibernate.criterion.Restrictions;

import com.mysql.cj.x.protobuf.MysqlxCrud.Order;

import org.hibernate.Criteria;
import org.hibernate.Query;

public class OrdersDaoImpl implements OrdersDAO{
	
	SessionFactory sf;
	Session session;
	
	@Override
	public String placeOrderDao(Orders order) {
		java.util.Date utilDate = new java.util.Date();
		Date currentDate = new Date(utilDate.getTime());
		
		Map<String, Object> sessionMap =
		FacesContext.getCurrentInstance().getExternalContext().getSessionMap();
		int custId = (int) sessionMap.get("customerId");
		int venId = (int) sessionMap.get("venId");
		int menuId = (int) sessionMap.get("menuId");
		double price = (Double) sessionMap.get("billAmount");
		double billAmount = price * order.getOrdquantity();
		System.out.println(billAmount);
		String payType = (String) sessionMap.get("payType");
		WalletSource ws = WalletSource.valueOf(payType);
		double walletAmount = new CustomerDaoImpl().purseValue(payType);
		if (walletAmount - billAmount > 0) {
			order.setCusid(custId);
			order.setVenid(venId);
			order.setWalsource(payType);
			order.setMenid(menuId);
			order.setOrdbillamount(billAmount);
			order.setOrdstatus(Ordstatus.PENDING);
			order.setOrddate(currentDate);
			System.out.println(order);
			double balance = walletAmount - billAmount;
			
			sf = SessionHelper.getConnection();
			session = sf.openSession();
			Transaction trans = session.beginTransaction();
			session.save(order);
			trans.commit();
			session.close();
			session = SessionHelper.getConnection().openSession();
			String q = "from Wallet where custId = " +custId + " AND walletSource = '" +ws +"'";
			System.out.println(q);
			Query query = session.createQuery(q);
			
			Wallet wallet = (Wallet)query.list().get(0);
			trans = session.beginTransaction(); 
			wallet.setWalletAmount(balance); 
			session.update(wallet);
			trans.commit();
			return "Dashboard.jsp?faces-redirect=true";
		} else {
			return "Message.jsp?faces-redirect=true";
		}
	
	}

	@Override
	public String orderHistory() {
		Map<String, Object> sessionMap = FacesContext.getCurrentInstance().getExternalContext().getSessionMap();
		sf = SessionHelper.getConnection();
		session = sf.openSession();
		int custId = (int) sessionMap.get("customerId");
		System.out.println(custId);
		Criteria criteria = session.createCriteria(Orders.class);
		criteria.add(Restrictions.eq("cusid",custId));
		
		List<Order> orderList = criteria.list();
		sessionMap.put("orderList",orderList);
		System.out.println("orderlist"+orderList);
		return "OrderHistory.jsp?faces-redirect=true"; 
	}

	@Override
	public String pendingOrder() {
		Map<String, Object> sessionMap = FacesContext.getCurrentInstance().getExternalContext().getSessionMap();
		sf = SessionHelper.getConnection();
		session = sf.openSession();
		int custId = (int) sessionMap.get("customerId");
		Criteria cr = session.createCriteria(Orders.class);
		cr.add(Restrictions.eq("cusid", custId));
		cr.add(Restrictions.eq("ordstatus", Ordstatus.PENDING));
		List<Order>orderList = cr.list();
		sessionMap.put("orderList", orderList);
		System.out.println("OrderList"+orderList);
		return "PendingOrder.jsp?faces-redirect=true";
	}
	public String venpendingOrder() {
		Map<String, Object> sessionMap = FacesContext.getCurrentInstance().getExternalContext().getSessionMap();
		sf = SessionHelper.getConnection();
		session = sf.openSession();
		int venId = (int) sessionMap.get("vendorId");
		Criteria cr = session.createCriteria(Orders.class);
		cr.add(Restrictions.eq("venid", venId));
		cr.add(Restrictions.eq("ordstatus", Ordstatus.PENDING));
		List<Order>orderList = cr.list();
		sessionMap.put("orderList", orderList);
		System.out.println("OrderList"+orderList);
		return "venPendingOrder.jsp?faces-redirect=true";
	}
	
	public String acceptOrder(int orderId) {
	    sf = SessionHelper.getConnection();
	    session = sf.openSession();
	    Transaction trans = session.beginTransaction();

	    // Load the order to be accepted by its ID
	    Orders order = session.get(Orders.class, ordid);

	    if (order != null) {
	        // Check if the order is in a pending state
	        if (order.getOrdstatus() == Ordstatus.PENDING) {
	            // Update the order status to "Accepted"
	            order.setOrdstatus(Ordstatus.ACCEPTED);

	            // Perform any other necessary actions, e.g., update the database
	            session.update(order);

	            trans.commit();

	            // Return a navigation outcome as needed
	            return "AcceptedOrderPage.xhtml?faces-redirect=true";
	        } else {
	            // Order is not in a pending state, handle accordingly
	            return "ErrorPage.xhtml?faces-redirect=true";
	        }
	    } else {
	        // Order with the specified ID not found, handle accordingly
	        return "ErrorPage.xhtml?faces-redirect=true";
	    }
	}

	
}
